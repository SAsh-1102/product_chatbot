<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emerging Software Assistant</title>

    <style>
        *{margin:0;padding:0;box-sizing:border-box;}

        body{
            font-family:Arial, Helvetica, sans-serif;
            background:#eef2f5;
            height:100vh;
        }

        /* ================================
           WIDGET
        =================================*/
        .chatbot-widget-container{
            position:fixed;
            bottom:20px;
            right:20px;
            z-index:9999;
        }

        .chatbot-tooltip{
            position:absolute;
            bottom:75px;
            right:0px;
            background:white;
            padding:7px 12px;
            border-radius:8px;
            font-size:13px;
            box-shadow:0 4px 10px rgba(0,0,0,0.12);
            animation:fadeOut 4s forwards;
        }

        @keyframes fadeOut {
            0%{opacity:1;}
            80%{opacity:1;}
            100%{opacity:0;}
        }

        .chatbot-toggle-btn{
            width:60px;
            height:60px;
            border-radius:50%;
            background:linear-gradient(135deg,#667eea,#764ba2);
            border:none;
            cursor:pointer;
            box-shadow:0 4px 12px rgba(0,0,0,0.15);
            display:flex;
            align-items:center;
            justify-content:center;
        }

        .chatbot-toggle-btn svg{width:32px;height:32px;fill:white;}

        /* ================================
           CHAT WINDOW
        =================================*/
        .chatbot-window{
            position:absolute;
            bottom:80px;
            right:0;
            width:380px;
            height:500px;
            background:white;
            border-radius:12px;
            box-shadow:0 5px 40px rgba(0,0,0,0.2);

            display: flex;
            flex-direction: column;
            transform: scale(0.95);
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .chatbot-window.active{
            transform: scale(1);
            opacity: 1;
            pointer-events: auto;
        }

        .chatbot-header{
            background:linear-gradient(135deg,#667eea,#764ba2);
            padding:18px;
            color:white;
            display:flex;
            justify-content:space-between;
            align-items:center;
        }

        .chatbot-header h3{margin:0;font-size:16px;}
        .chatbot-close-btn{
            font-size:25px;
            border:none;
            background:none;
            color:white;
            cursor:pointer;
        }

        .chatbot-messages{
            flex:1;
            padding:15px;
            overflow-y:auto;
            background:#f7f7f7;
        }

        .widget-message{
            margin-bottom:10px;
            display:flex;
        }

        .widget-message.user{justify-content:flex-end;}

        .widget-message-content{
            max-width:70%;
            padding:10px 14px;
            border-radius:12px;
            font-size:14px;
        }

        .widget-message.bot .widget-message-content{
            background:white;border:1px solid #ddd;color:#333;
        }

        .widget-message.user .widget-message-content{
            background:linear-gradient(135deg,#667eea,#764ba2);
            color:white;
        }

        .chatbot-input-area{
            padding:12px;
            background:white;
            display:flex;
            gap:10px;
            border-top:1px solid #ddd;
        }

        .chatbot-input{
            flex:1;
            padding:10px;
            border:1px solid #ccc;
            border-radius:8px;
        }

        .chatbot-send-btn{
            padding:10px 18px;
            background:linear-gradient(135deg,#667eea,#764ba2);
            color:white;
            border:none;
            border-radius:8px;
            cursor:pointer;
        }

        /* MIC BUTTON */
        #micBtn{
            width:45px;
            height:45px;
            border-radius:50%;
            border:none;
            background:#482ceb;
            color:white;
            font-size:20px;
            cursor:pointer;
        }

        .loading-dots span{
            width:7px;height:7px;border-radius:50%;
            background:#667eea;
            display:inline-block;
            animation:bounce 1.2s infinite;
            margin-right:4px;
        }
        .loading-dots span:nth-child(2){animation-delay:.2s;}
        .loading-dots span:nth-child(3){animation-delay:.4s;}

        @keyframes bounce{
            0%,80%,100%{transform:translateY(0);}
            40%{transform:translateY(-7px);}
        }

        .quick-options button{
            margin:3px;
            padding:5px 10px;
            border:none;
            border-radius:6px;
            cursor:pointer;
            background:#667eea;
            color:white;
        }
    </style>
</head>

<body>
    <div class="chatbot-widget-container">
        <div class="chatbot-tooltip">I‚Äôm here to help ‚Äî ask anything! </div>

        <button class="chatbot-toggle-btn" id="chatbotToggle">
            <svg viewBox="0 0 24 24">
                <path d="M20 2H4c-1.1 0-2 
                .9-2 2v18l4-4h14c1.1 0 2-.9 
                2-2V4c0-1.1-.9-2-2-2zm-2 
                12h-8v-2h8v2zm0-4h-8V8h8v2z"/>
            </svg>
        </button>

        <div class="chatbot-window" id="chatbotWindow">
            <div class="chatbot-header">
                <h3>üöÄ Emerging Software</h3>
                <button class="chatbot-close-btn" id="chatbotClose">√ó</button>
            </div>

            <div class="chatbot-messages" id="messagesContainer"></div>

            <div class="chatbot-input-area">
                <button id="micBtn">üé§</button>
                <input type="text" class="chatbot-input" id="chatbotInput" placeholder="Type here...">
                <button class="chatbot-send-btn" id="chatbotSendBtn">Send</button>
            </div>
        </div>
    </div>

<script>
    const toggleBtn = document.getElementById("chatbotToggle");
    const closeBtn = document.getElementById("chatbotClose");
    const win = document.getElementById("chatbotWindow");
    const msgBox = document.getElementById("messagesContainer");
    const input = document.getElementById("chatbotInput");

    toggleBtn.onclick = () => {
        win.classList.toggle("active");

        if(msgBox.children.length === 0){
            addBot("üëã Hello! Welcome to Emerging Software.<br>How can I assist you today?");
            setTimeout(() => {
                addBot(`
                    <div class="quick-options">
                        <button onclick="quickAsk('Email Marketing')">üìß Email Marketing</button>
                        <button onclick="quickAsk('Digital Marketing')">üìà Digital Marketing</button>
                        <button onclick="quickAsk('SEO Services')">üîç SEO Services</button>
                        <button onclick="quickAsk('Contact Info')">üìû Contact Information</button>
                    </div>
                `);
            }, 800);
        }
    };

    closeBtn.onclick = () => win.classList.remove("active");

    document.getElementById("chatbotSendBtn").onclick = sendMsg;
    input.addEventListener("keypress", e => e.key === "Enter" && sendMsg());

    function addMsg(text, sender){
        const div = document.createElement("div");
        div.className = `widget-message ${sender}`;
        div.innerHTML = `<div class="widget-message-content">${text}</div>`;
        msgBox.appendChild(div);
        msgBox.scrollTop = msgBox.scrollHeight;
    }

    function addUser(t){ addMsg(t, "user"); }
    function addBot(t){ addMsg(t, "bot"); }

    async function sendMsg(){
        const txt = input.value.trim();
        if(!txt) return;

        addUser(txt);
        input.value = "";

        const loading = document.createElement("div");
        loading.className = "widget-message bot";
        loading.innerHTML = `
            <div class="widget-message-content">
                <div class="loading-dots">
                    <span></span><span></span><span></span>
                </div>
            </div>`;
        msgBox.appendChild(loading);

        try {
            const res = await fetch("/ask", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ query: txt })
            });
            const data = await res.json();
            loading.remove();
            addBot(data.answer || "Sorry, no response!");
        } catch(err){
            loading.remove();
            addBot("‚ùå Server error. Try again!");
        }
    }

    function quickAsk(text){
        addUser(text);
        sendQuick(text);
    }

    async function sendQuick(text){
        const loading = document.createElement("div");
        loading.className = "widget-message bot";
        loading.innerHTML = `
            <div class="widget-message-content">
                <div class="loading-dots">
                    <span></span><span></span><span></span>
                </div>
            </div>`;
        msgBox.appendChild(loading);

        try {
            const res = await fetch("/ask", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ query: text })
            });
            const data = await res.json();
            loading.remove();
            addBot(data.answer || "Sorry, no response!");
        } catch(err){
            loading.remove();
            addBot("‚ùå Server error. Try again!");
        }
    }

    /* ------------------------
       SPEECH TO TEXT (MIC)
    -------------------------*/
    let isRecording = false;
    let recognition;

    if ("webkitSpeechRecognition" in window) {
        recognition = new webkitSpeechRecognition();
        recognition.lang = "en-US";
        recognition.continuous = false;
        recognition.interimResults = false;

        recognition.onresult = function(event) {
            const voiceText = event.results[0][0].transcript;
            input.value = voiceText;
            sendMsg(); // AUTO SEND
        };

        recognition.onend = function() {
            isRecording = false;
            document.getElementById("micBtn").style.background = "#482ceb";
        };
    }

    document.getElementById("micBtn").onclick = () => {
        if (!isRecording) {
            recognition.start();
            isRecording = true;
            document.getElementById("micBtn").style.background = "#4CAF50"; 
        } else {
            recognition.stop();
            isRecording = false;
            document.getElementById("micBtn").style.background = "#482ceb";
        }
    };
</script>
</body>
</html>
